#!/bin/bash
set -e

[ -z "$(snapctl get fwmark)" ] && snapctl set fwmark="0"
[ -z "$(snapctl get listen)" ] && snapctl set listen=":8443"

fwmark="$(snapctl get fwmark)"
http_proxy="$(snapctl get http.proxy)"
https_proxy="$(snapctl get https.proxy)"
listen="$(snapctl get listen)"
proxy="$(snapctl get proxy)"

[ -n "${proxy}" ] && echo "proxy configuration is deprecated, use http.proxy and https.proxy instead" 1>&2

# for backward compatability
[ -z "${http_proxy}" ] && [ -n "${proxy}" ] && http_proxy="http://${proxy}"
[ -z "${https_proxy}" ] && [ -n "${proxy}" ] && https_proxy="http://${proxy}"

echo "--http-proxy='${http_proxy}' --https-proxy='${https_proxy}' --listen='${listen}' --fwmark='${fwmark}'" > $SNAP_DATA/args

snapctl stop ${SNAP_NAME}.aproxy
snapctl start ${SNAP_NAME}.aproxy --enable
