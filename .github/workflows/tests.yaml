# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.

name: Run End-to-End test

on:
  pull_request:
  workflow_call:

jobs:
  e2e-test:
    name: End-to-End Test Run
    runs-on: [ self-hosted, amd64, edge ]
    steps:
      - name: ssh_config.d
        run: |
          ls -lah /etc/ssh/ssh_config.d/
      - name: check aproxy
        run: |
          sudo snap get aproxy
      - name: check nftables
        run: |
          sudo nft list ruleset
      - name: test TCP connectivity
        run: |
          echo hello | nc -q 0 tcpbin.com 4242
      - name: test HTTP
        run: |
          timeout 60 curl --noproxy "*" http://example.com -svS -o /dev/null
      - name: test HTTPS
        run: |
          timeout 60 curl --noproxy "*" https://example.com -svS -o /dev/null
      - name: test HKP
        run: |
          timeout 60 gpg -vvv --keyserver hkp://keyserver.ubuntu.com --recv-keys E1DE584A8CCA52DC29550F18ABAC58F075A17EFA
      - name: test SSH
        run: |
          ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
          echo '${{ secrets.GITLAB_SSH_ID_ED25519 }}' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          cd ~
          git clone git@gitlab.com:gitlab-org/gitlab.git
      - name: show aproxy logs
        if: always()
        run: |
          sudo snap get aproxy
          sudo snap logs aproxy.aproxy -n=all
          sudo nft list ruleset
