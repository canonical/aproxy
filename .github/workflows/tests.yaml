# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.

name: Run End-to-End test

on:
  pull_request:
  workflow_call:

jobs:
  e2e-test:
    name: End-to-End Test Run
    runs-on: [self-hosted, x64]
    steps:
      - name: install microk8s
        run: sudo snap install microk8s --channel=1.32-strict/stable

      - name: update microk8s containerd config
        run: |
          MIRROR_CONFIG=/opt/containerd/k8s-containerd/etc/containerd/hosts.d/docker.io

          sudo mkdir -p ${MIRROR_CONFIG}
          sudo chown $USER ${MIRROR_CONFIG}
          cat << EOF > ${MIRROR_CONFIG}/hosts.toml
          [host."$DOCKERHUB_MIRROR"]
          capabilities = ["pull", "resolve"]
          EOF

      - name: restart microk8s
        run: |
          sudo snap restart microk8s

      - name: Tmate debugging session (self-hosted)
        uses: canonical/action-tmate@main
        timeout-minutes: 60
